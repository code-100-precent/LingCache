# 主从复制 vs 分片集群 - 对比指南

## 概述

LingCache 支持两种分布式模式：
- **主从复制（Replication）**：数据复制，高可用性
- **分片集群（Sharding Cluster）**：数据分片，水平扩展

虽然它们的使用方法看起来相似，但解决的问题和适用场景完全不同。

---

## 核心区别

### 1. 数据分布方式

| 特性 | 主从复制 | 分片集群 |
|------|---------|---------|
| **数据存储** | 所有数据在主节点，从节点复制 | 数据分片到多个节点 |
| **数据量** | 受单机内存限制 | 可突破单机限制 |
| **扩展性** | 垂直扩展（增加从节点） | 水平扩展（增加主节点） |

**主从复制**：
```
主节点 (Master)
  ├─ 所有数据 (100%)
  ├─ 从节点1 (Replica) - 复制 100% 数据
  └─ 从节点2 (Replica) - 复制 100% 数据
```

**分片集群**：
```
节点1 (Master) - 槽 0-5460    (33% 数据)
节点2 (Master) - 槽 5461-10922 (33% 数据)
节点3 (Master) - 槽 10923-16383 (34% 数据)
```

### 2. 使用场景

#### 主从复制适用于：
- ✅ **小到中等数据量**（单机内存可容纳）
- ✅ **高可用性需求**（主节点故障时从节点接管）
- ✅ **读写分离**（从节点处理读请求）
- ✅ **数据备份**（从节点作为备份）
- ✅ **简单部署**（配置简单，易于管理）

#### 分片集群适用于：
- ✅ **大数据量**（超过单机内存容量）
- ✅ **水平扩展需求**（需要增加存储容量）
- ✅ **高并发写入**（分散写入压力）
- ✅ **数据分片**（数据自动分布到多个节点）
- ✅ **复杂场景**（需要精细的数据分布控制）

### 3. 命令对比

#### 主从复制命令

```bash
# 将当前节点设置为从节点
SLAVEOF 127.0.0.1 6379

# 停止复制，成为主节点
SLAVEOF NO ONE

# 配置复制参数
REPLCONF listening-port 6380
REPLCONF capa eof

# 同步请求
PSYNC ? -1
```

#### 分片集群命令

```bash
# 节点握手
CLUSTER MEET 127.0.0.1 7001

# 查看集群信息
CLUSTER INFO
CLUSTER NODES
CLUSTER SLOTS

# 分配槽
CLUSTER ADDSLOTS 0 1 2 ... 5460
```

---

## 使用方式对比

### 主从复制使用流程

#### 1. 启动主节点

```bash
# 主节点（端口 6379）
./lingcache-server -addr :6379
```

#### 2. 启动从节点

```bash
# 从节点（端口 6380）
./lingcache-server -addr :6380
```

#### 3. 配置从节点

```bash
# 连接到从节点
node client.js

# 设置为从节点
SLAVEOF 127.0.0.1 6379
```

#### 4. 验证复制

```bash
# 在主节点写入
SET key1 value1

# 在从节点读取（应该能读到）
GET key1
```

**特点**：
- ✅ 配置简单，一条命令即可
- ✅ 自动同步，主节点写入后自动复制到从节点
- ✅ 从节点只读，不能写入

### 分片集群使用流程

#### 1. 启动多个节点

```bash
# 节点1（端口 7000）
./lingcache-server -addr :7000
# 配置: REDIS_CLUSTER_ENABLED=true

# 节点2（端口 7001）
./lingcache-server -addr :7001
# 配置: REDIS_CLUSTER_ENABLED=true

# 节点3（端口 7002）
./lingcache-server -addr :7002
# 配置: REDIS_CLUSTER_ENABLED=true
```

#### 2. 节点握手

```bash
# 连接到任意节点
CLUSTER MEET 127.0.0.1 7001
CLUSTER MEET 127.0.0.1 7002
```

#### 3. 分配槽

```bash
# 节点1分配槽 0-5460
CLUSTER ADDSLOTS 0 1 2 ... 5460

# 节点2分配槽 5461-10922
CLUSTER ADDSLOTS 5461 5462 ... 10922

# 节点3分配槽 10923-16383
CLUSTER ADDSLOTS 10923 10924 ... 16383
```

#### 4. 使用数据

```bash
# 数据自动路由到正确的节点
SET user:1000 "Alice"  # 可能路由到节点1
SET user:2000 "Bob"    # 可能路由到节点2
SET user:3000 "Charlie" # 可能路由到节点3
```

**特点**：
- ⚠️ 配置较复杂，需要节点握手和槽分配
- ✅ 数据自动分片，根据键的哈希值路由
- ✅ 所有节点都可以读写

---

## 功能对比表

| 功能 | 主从复制 | 分片集群 |
|------|---------|---------|
| **数据复制** | ✅ 完整复制 | ❌ 不复制（分片） |
| **数据分片** | ❌ 不分片 | ✅ 自动分片 |
| **水平扩展** | ❌ 不支持 | ✅ 支持 |
| **垂直扩展** | ✅ 支持（增加从节点） | ❌ 不支持 |
| **读写分离** | ✅ 支持 | ❌ 不支持 |
| **故障转移** | ✅ 支持（从节点提升） | ✅ 支持（更复杂） |
| **数据一致性** | ✅ 最终一致性 | ✅ 最终一致性 |
| **跨节点操作** | ✅ 支持（所有数据在同一节点） | ⚠️ 受限（需要使用哈希标签） |
| **配置复杂度** | ⭐ 简单 | ⭐⭐⭐ 复杂 |
| **运维复杂度** | ⭐ 简单 | ⭐⭐⭐ 复杂 |

---

## 如何选择？

### 选择主从复制，如果：

1. **数据量小**：数据可以完全放在单机内存中
2. **高可用性**：需要主节点故障时自动切换
3. **读写分离**：需要从节点处理读请求，减轻主节点压力
4. **简单部署**：希望配置简单，易于管理
5. **数据备份**：需要从节点作为数据备份

**典型场景**：
- 缓存服务（数据量不大）
- 会话存储
- 配置中心
- 小到中型应用

### 选择分片集群，如果：

1. **数据量大**：数据超过单机内存容量
2. **水平扩展**：需要增加存储容量和性能
3. **高并发写入**：需要分散写入压力到多个节点
4. **数据分片**：需要将数据分布到多个节点
5. **复杂场景**：需要精细的数据分布控制

**典型场景**：
- 大数据缓存
- 高并发写入场景
- 需要突破单机限制
- 大型分布式应用

---

## 组合使用

### 主从复制 + 分片集群

可以同时使用两种模式，实现**分片集群 + 主从复制**：

```
分片集群（3个主节点）
  ├─ 主节点1 (槽 0-5460)
  │   ├─ 从节点1-1
  │   └─ 从节点1-2
  ├─ 主节点2 (槽 5461-10922)
  │   ├─ 从节点2-1
  │   └─ 从节点2-2
  └─ 主节点3 (槽 10923-16383)
      ├─ 从节点3-1
      └─ 从节点3-2
```

**优势**：
- ✅ 数据分片（水平扩展）
- ✅ 高可用性（每个主节点有从节点）
- ✅ 读写分离（从节点处理读请求）

**配置**：
1. 先配置分片集群（主节点）
2. 再为每个主节点配置从节点（SLAVEOF）

---

## 实际使用示例

### 示例 1: 小型应用（主从复制）

```bash
# 场景：数据量 1GB，需要高可用性

# 主节点
./lingcache-server -addr :6379

# 从节点（备份和读请求）
./lingcache-server -addr :6380
# 在从节点执行: SLAVEOF 127.0.0.1 6379
```

**优点**：
- 配置简单
- 自动故障转移
- 读写分离

### 示例 2: 大型应用（分片集群）

```bash
# 场景：数据量 100GB，需要水平扩展

# 3个主节点
./lingcache-server -addr :7000  # 节点1
./lingcache-server -addr :7001  # 节点2
./lingcache-server -addr :7002  # 节点3

# 节点握手和槽分配
CLUSTER MEET 127.0.0.1 7001
CLUSTER MEET 127.0.0.1 7002
CLUSTER ADDSLOTS ...
```

**优点**：
- 数据分片
- 水平扩展
- 高并发支持

### 示例 3: 大型高可用应用（组合模式）

```bash
# 场景：数据量 100GB，需要高可用性

# 3个主节点（分片）
./lingcache-server -addr :7000  # 主节点1
./lingcache-server -addr :7001  # 主节点2
./lingcache-server -addr :7002  # 主节点3

# 6个从节点（每个主节点2个从节点）
./lingcache-server -addr :7100  # 从节点1-1
./lingcache-server -addr :7101  # 从节点1-2
./lingcache-server -addr :7110  # 从节点2-1
./lingcache-server -addr :7111  # 从节点2-2
./lingcache-server -addr :7120  # 从节点3-1
./lingcache-server -addr :7121  # 从节点3-2

# 配置从节点
# 在 7100 执行: SLAVEOF 127.0.0.1 7000
# 在 7101 执行: SLAVEOF 127.0.0.1 7000
# ...
```

**优点**：
- 数据分片 + 高可用性
- 读写分离
- 故障自动转移

---

## 性能对比

### 主从复制

- **写入性能**：受主节点限制
- **读取性能**：可以从多个从节点读取（读写分离）
- **扩展性**：垂直扩展（增加从节点）

### 分片集群

- **写入性能**：分散到多个节点（水平扩展）
- **读取性能**：分散到多个节点
- **扩展性**：水平扩展（增加主节点）

---

## 总结

| 维度 | 主从复制 | 分片集群 |
|------|---------|---------|
| **核心目标** | 高可用性 + 数据备份 | 水平扩展 + 数据分片 |
| **数据分布** | 完整复制 | 分片存储 |
| **适用数据量** | 小到中等 | 大型 |
| **配置复杂度** | 简单 | 复杂 |
| **运维复杂度** | 简单 | 复杂 |
| **使用场景** | 高可用性需求 | 大数据量需求 |

**建议**：
- 🎯 **小到中型应用**：使用主从复制
- 🎯 **大型应用**：使用分片集群
- 🎯 **大型高可用应用**：使用分片集群 + 主从复制

---

## 相关文档

- [主从复制使用指南](../replication/) - 主从复制详细文档
- [分片集群教程](./cluster/SHARDING_CLUSTER_GUIDE.md) - 分片集群详细教程
- [集群使用指南](./cluster/USAGE_GUIDE.md) - 完整集群文档

---

**最后更新**: 2024-12-20
**版本**: 1.0.0

